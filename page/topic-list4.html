<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>选题结果 - 毕业设计课题选择管理系统</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
		<link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
		<link rel="stylesheet" href="../css/public.css" media="all">
		<style>
			.layui-card {
				margin-bottom: 15px;
			}

			.layui-form-item {
				margin-bottom: 15px;
			}

			.operation-btn {
				margin-right: 5px;
			}

			.statistics-container {
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				margin-bottom: 15px;
			}

			.statistics-card {
				flex: 1;
				min-width: 200px;
				text-align: center;
				padding: 15px;
			}

			.statistics-value {
				font-size: 24px;
				font-weight: bold;
				margin: 10px 0;
			}

			.statistics-label {
				color: #666;
			}

			.student-tag {
				display: inline-block;
				background-color: #f2f2f2;
				border-radius: 4px;
				padding: 2px 8px;
				margin: 2px;
				font-size: 12px;
			}
		</style>
	</head>
	<body>
		<div class="layuimini-container">
			<div class="layuimini-main">
				<!-- 页面标题区域 -->
				<div class="layui-card">
					<div class="layui-card-header">
						<i class="fa fa-check-square-o icon"></i>选题结果管理
						<button class="layui-btn layui-btn-sm layui-btn-primary" style="margin-left:10px" onclick="exportResults()">
							<i class="fa fa-download"></i> 导出结果
						</button>
					</div>
				</div>

				<!-- 统计数据区域 -->
				<div class="layui-card">
					<div class="layui-card-body">
						<div class="statistics-container">
							<div class="layui-card statistics-card">
								<div class="statistics-value" id="totalTopics">0</div>
								<div class="statistics-label">总课题数</div>
							</div>
							<div class="layui-card statistics-card">
								<div class="statistics-value" id="selectedTopics">0</div>
								<div class="statistics-label">已选课题数</div>
							</div>
							<div class="layui-card statistics-card">
								<div class="statistics-value" id="totalStudents">0</div>
								<div class="statistics-label">总学生数</div>
							</div>
							<div class="layui-card statistics-card">
								<div class="statistics-value" id="unselectedStudents">0</div>
								<div class="statistics-label">未选题学生数</div>
							</div>
						</div>
					</div>
				</div>

				<!-- 搜索区域 -->
				<div class="layui-card">
					<div class="layui-card-body">
						<form class="layui-form" lay-filter="searchForm" id="searchForm">
							<div class="layui-form-item">
								<div class="layui-col-md3">
									<input type="text" name="topicName" placeholder="搜索课题名称" autocomplete="off"
										class="layui-input">
								</div>
								<div class="layui-col-md3">
									<select name="teacher">
										<option value="">所有教师</option>
										<option value="1">张教授</option>
										<option value="2">李副教授</option>
										<option value="3">王老师</option>
										<option value="4">赵讲师</option>
										<option value="5">刘教授</option>
									</select>
								</div>
								<div class="layui-col-md3">
									<select name="selectionStatus">
										<option value="">所有状态</option>
										<option value="1">已分配满</option>
										<option value="2">还有名额</option>
										<option value="3">未分配</option>
									</select>
								</div>
								<div class="layui-col-md3">
									<button class="layui-btn" lay-submit lay-filter="searchBtn"><i
											class="fa fa-search"></i> 搜索</button>
									<button type="reset" class="layui-btn layui-btn-primary" id="resetBtn"><i
											class="fa fa-refresh"></i> 重置搜索</button>
								</div>
							</div>
						</form>
					</div>
				</div>

				<!-- 选题结果列表 -->
				<div class="layui-card">
					<div class="layui-card-body">
						<table class="layui-table" lay-size="sm">
							<thead>
								<tr>
									<th>序号</th>
									<th>课题名称</th>
									<th>课题类型</th>
									<th>指导教师</th>
									<th>计划人数</th>
									<th>已选人数</th>
									<th>选题状态</th>
									<th>已选学生</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="resultsTableBody">
								<!-- 数据将动态生成 -->
							</tbody>
						</table>

						<div id="pagination" style="text-align: right;"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- 分配学生弹窗 -->
		<div id="assignModal" style="display: none;">
			<form class="layui-form" lay-filter="assignForm" id="assignForm">
				<input type="hidden" name="topicId">
				<div class="layui-form-item">
					<label class="layui-form-label">课题名称</label>
					<div class="layui-input-block" id="assignTopicName" style="padding-top: 7px;"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">计划人数</label>
					<div class="layui-input-block" id="assignStudentNum" style="padding-top: 7px;"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">已选人数</label>
					<div class="layui-input-block" id="assignedCount" style="padding-top: 7px;"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">可分配人数</label>
					<div class="layui-input-block" id="availableCount" style="padding-top: 7px;"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">未选题学生</label>
					<div class="layui-input-block">
						<select name="studentId" lay-verify="required" id="unselectedStudentsSelect" multiple size="8" style="width:100%;">
							<!-- 动态加载未选题学生 -->
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn" lay-submit lay-filter="saveAssignment">确认分配</button>
						<button type="button" class="layui-btn layui-btn-primary" onclick="closeModal()">取消</button>
					</div>
				</div>
			</form>
		</div>

		<!-- 学生列表弹窗 -->
		<div id="studentsModal" style="display: none;">
			<div class="layui-form">
				<div class="layui-form-item">
					<label class="layui-form-label">课题名称</label>
					<div class="layui-input-block" id="modalTopicName"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">指导教师</label>
					<div class="layui-input-block" id="modalTeacher"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">学生列表</label>
					<div class="layui-input-block" id="modalStudentsList">
						<!-- 动态加载学生列表 -->
					</div>
				</div>
			</div>
		</div>

		<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
		<script>
			layui.use(['form', 'laypage', 'layer'], function() {
				var form = layui.form;
				var laypage = layui.laypage;
				var layer = layui.layer;
				var $ = layui.jquery;

				// 全局变量
				var currentPage = 1;
				var pageSize = 10;
				var totalCount = 0;
				var searchParams = {};
				var modalIndex = null;
				
				// 初始化页面
				init();

				function init() {
					// 确保有模拟数据
					initMockData();
					// 加载列表
					loadResultsList();
					// 更新统计数据
					updateStatistics();
					// 绑定事件
					bindEvents();
				}

				// 初始化模拟数据关联关系
				function initMockData() {
					// 确保学生和课题数据存在
					if (!localStorage.getItem('topics')) {
						// 如果没有课题数据，初始化课题数据
						const topics = [
							{id: 1, topicName: '基于深度学习的图像识别算法研究', teacherId: 1, teacherName: '张教授', type: 1, typeName: '研究型', studentNum: 2},
							{id: 2, topicName: '智能校园导航系统设计', teacherId: 1, teacherName: '张教授', type: 2, typeName: '应用型', studentNum: 3},
							{id: 3, topicName: '零件缺陷机器视觉检测', teacherId: 1, teacherName: '张教授', type: 1, typeName: '研究型', studentNum: 2},
							{id: 4, topicName: '校园安防异常行为识别', teacherId: 1, teacherName: '张教授', type: 2, typeName: '应用型', studentNum: 4},
							{id: 5, topicName: 'B2C电商平台设计与实现', teacherId: 2, teacherName: '李副教授', type: 2, typeName: '应用型', studentNum: 3},
							{id: 6, topicName: '社交媒体情感分析系统', teacherId: 2, teacherName: '李副教授', type: 1, typeName: '研究型', studentNum: 2},
							{id: 7, topicName: '图书馆书籍智能分类系统', teacherId: 3, teacherName: '王老师', type: 2, typeName: '应用型', studentNum: 3},
							{id: 8, topicName: '校园二手交易平台设计', teacherId: 3, teacherName: '王老师', type: 2, typeName: '应用型', studentNum: 3},
							{id: 9, topicName: '移动办公APP设计与实现', teacherId: 4, teacherName: '赵讲师', type: 3, typeName: '设计型', studentNum: 3},
							{id: 10, topicName: '新能源汽车电池管理系统研究', teacherId: 5, teacherName: '刘教授', type: 1, typeName: '研究型', studentNum: 2}
						];
						localStorage.setItem('topics', JSON.stringify(topics));
					}
					
					if (!localStorage.getItem('students')) {
						// 如果没有学生数据，初始化学生数据
						const students = [
							{id: 1, studentName: '张明', studentId: '202101010001', majorName: '计算机科学与技术', topicId: 1, topicName: '基于深度学习的图像识别算法研究', teacherId: 1},
							{id: 2, studentName: '李华', studentId: '202101010002', majorName: '计算机科学与技术', topicId: 1, topicName: '基于深度学习的图像识别算法研究', teacherId: 1},
							{id: 3, studentName: '王芳', studentId: '202101010003', majorName: '计算机科学与技术', topicId: 2, topicName: '智能校园导航系统设计', teacherId: 1},
							{id: 4, studentName: '刘伟', studentId: '202201010001', majorName: '计算机科学与技术', topicId: 2, topicName: '智能校园导航系统设计', teacherId: 1},
							{id: 5, studentName: '陈静', studentId: '202201010002', majorName: '计算机科学与技术', topicId: 5, topicName: 'B2C电商平台设计与实现', teacherId: 2},
							{id: 6, studentName: '赵强', studentId: '202102010001', majorName: '软件工程', topicId: 5, topicName: 'B2C电商平台设计与实现', teacherId: 2},
							{id: 7, studentName: '孙丽', studentId: '202102010002', majorName: '软件工程', topicId: 7, topicName: '图书馆书籍智能分类系统', teacherId: 3},
							{id: 8, studentName: '周杰', studentId: '202102010003', majorName: '软件工程', topicId: null, topicName: '未选题', teacherId: ''},
							{id: 9, studentName: '吴敏', studentId: '202202010001', majorName: '软件工程', topicId: 8, topicName: '校园二手交易平台设计', teacherId: 3},
							{id: 10, studentName: '郑亮', studentId: '202202010002', majorName: '软件工程', topicId: 9, topicName: '移动办公APP设计与实现', teacherId: 4},
							{id: 11, studentName: '钱小红', studentId: '202103010001', majorName: '人工智能', topicId: 3, topicName: '零件缺陷机器视觉检测', teacherId: 1},
							{id: 12, studentName: '孙伟', studentId: '202103010002', majorName: '人工智能', topicId: 6, topicName: '社交媒体情感分析系统', teacherId: 2},
							{id: 13, studentName: '周婷', studentId: '202203010001', majorName: '人工智能', topicId: null, topicName: '未选题', teacherId: ''},
							{id: 14, studentName: '吴迪', studentId: '202203010002', majorName: '人工智能', topicId: 10, topicName: '新能源汽车电池管理系统研究', teacherId: 5},
							{id: 15, studentName: '郑华', studentId: '202104010001', majorName: '数据科学与大数据技术', topicId: null, topicName: '未选题', teacherId: ''},
							{id: 16, studentName: '王佳', studentId: '202104010002', majorName: '数据科学与大数据技术', topicId: 4, topicName: '校园安防异常行为识别', teacherId: 1},
							{id: 17, studentName: '冯伟', studentId: '202105010001', majorName: '信息安全', topicId: 4, topicName: '校园安防异常行为识别', teacherId: 1},
							{id: 18, studentName: '陈思思', studentId: '202105010002', majorName: '信息安全', topicId: 4, topicName: '校园安防异常行为识别', teacherId: 1},
							{id: 19, studentName: '黄志强', studentId: '202205010001', majorName: '信息安全', topicId: 9, topicName: '移动办公APP设计与实现', teacherId: 4},
							{id: 20, studentName: '林小燕', studentId: '202205010002', majorName: '信息安全', topicId: null, topicName: '未选题', teacherId: ''}
						];
						localStorage.setItem('students', JSON.stringify(students));
					}
				}

				// 获取所有课题数据
				function getAllTopics() {
					return JSON.parse(localStorage.getItem('topics') || '[]');
				}

				// 获取所有学生数据
				function getAllStudents() {
					return JSON.parse(localStorage.getItem('students') || '[]');
				}

				// 保存学生数据
				function saveStudents(students) {
					localStorage.setItem('students', JSON.stringify(students));
				}

				// 获取特定课题的学生
				function getStudentsByTopicId(topicId) {
					return getAllStudents().filter(student => student.topicId == topicId);
				}

				// 加载选题结果列表
				function loadResultsList() {
					let allTopics = getAllTopics();
					let allStudents = getAllStudents();

					// 处理课题数据，添加已选学生信息
					let topicsWithStudents = allTopics.map(topic => {
						const students = getStudentsByTopicId(topic.id);
						return {
							...topic,
							selectedStudents: students,
							selectedCount: students.length,
							selectionStatus: students.length >= topic.studentNum ? 1 : (students.length > 0 ? 2 : 3)
						};
					});

					// 搜索过滤逻辑
					let filteredTopics = topicsWithStudents.filter(topic => {
						// 课题名称模糊搜索
						if (searchParams.topicName) {
							const searchStr = searchParams.topicName.toLowerCase();
							if (!topic.topicName.toLowerCase().includes(searchStr)) {
								return false;
							}
						}
						// 教师筛选
						if (searchParams.teacher && topic.teacherId != searchParams.teacher) {
							return false;
						}
						// 选题状态筛选
						if (searchParams.selectionStatus !== undefined && topic.selectionStatus != searchParams.selectionStatus) {
							return false;
						}
						return true;
					});

					// 分页处理
					totalCount = filteredTopics.length;
					let startIndex = (currentPage - 1) * pageSize;
					let currentTopics = filteredTopics.slice(startIndex, startIndex + pageSize);

					// 渲染表格
					renderTable(currentTopics);
					// 渲染分页
					renderPagination();
				}

				// 渲染表格
				function renderTable(topics) {
					const tableBody = $('#resultsTableBody');
					tableBody.empty();

					if (topics.length === 0) {
						tableBody.html('<tr><td colspan="9" style="text-align: center;">暂无数据</td></tr>');
						return;
					}

					topics.forEach((topic, index) => {
						// 状态样式和文本
						let statusText, statusStyle;
						switch(topic.selectionStatus) {
							case 1:
								statusText = "已分配满";
								statusStyle = "layui-bg-green";
								break;
							case 2:
								statusText = "还有名额";
								statusStyle = "layui-bg-blue";
								break;
							case 3:
								statusText = "未分配";
								statusStyle = "layui-bg-gray";
								break;
						}

						// 生成学生标签
						let studentTags = topic.selectedStudents.length > 0 ? 
							topic.selectedStudents.map(student => 
								`<span class="student-tag">${student.studentName}(${student.studentId})</span>`
							).join('') : 
							'<span style="color:#999">无</span>';
						
						// 分配按钮状态
						const assignBtnDisabled = topic.selectionStatus === 1 ? 'disabled' : '';
						const assignBtnClass = topic.selectionStatus === 1 ? 'layui-btn-disabled' : '';

						const tr = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${topic.topicName}</td>
                        <td>${topic.typeName}</td>
                        <td>${topic.teacherName}</td>
                        <td>${topic.studentNum}</td>
                        <td>${topic.selectedCount}</td>
                        <td><span class="layui-badge ${statusStyle}">${statusText}</span></td>
                        <td>
                            <div style="max-width:200px; white-space:normal;">
                                ${studentTags}
                            </div>
                        </td>
                        <td>
                            <button class="layui-btn layui-btn-xs operation-btn" onclick="viewTopicStudents(${topic.id})">查看学生</button>
                            <button class="layui-btn layui-btn-normal layui-btn-xs operation-btn ${assignBtnClass}" ${assignBtnDisabled} onclick="assignStudents(${topic.id})">分配学生</button>
                        </td>
                    </tr>
                `;
						tableBody.append(tr);
					});
				}

				// 渲染分页
				function renderPagination() {
					laypage.render({
						elem: 'pagination',
						count: totalCount,
						limit: pageSize,
						limits: [5, 10, 15, 20],
						curr: currentPage,
						layout: ['prev', 'page', 'next', 'count', 'limit', 'skip'],
						jump: function(obj, first) {
							if (!first) {
								currentPage = obj.curr;
								pageSize = obj.limit;
								loadResultsList();
							}
						}
					});
				}

				// 更新统计数据
				function updateStatistics() {
					const allTopics = getAllTopics();
					const allStudents = getAllStudents();
					
					// 总课题数
					const totalTopics = allTopics.length;
					
					// 已选课题数（有学生选择的课题）
					const selectedTopics = allTopics.filter(topic => 
						getStudentsByTopicId(topic.id).length > 0
					).length;
					
					// 总学生数
					const totalStudents = allStudents.length;
					
					// 未选题学生数
					const unselectedStudents = allStudents.filter(student => 
						!student.topicId || student.topicId === null || student.topicId === ''
					).length;
					
					// 更新页面统计数据
					$('#totalTopics').text(totalTopics);
					$('#selectedTopics').text(selectedTopics);
					$('#totalStudents').text(totalStudents);
					$('#unselectedStudents').text(unselectedStudents);
				}

				// 绑定事件
				function bindEvents() {
					// 搜索事件
					form.on('submit(searchBtn)', function(data) {
						searchParams = {};
						if (data.field.topicName && data.field.topicName.trim() !== '') {
							searchParams.topicName = data.field.topicName.trim();
						}
						if (data.field.teacher) {
							searchParams.teacher = data.field.teacher;
						}
						if (data.field.selectionStatus) {
							searchParams.selectionStatus = parseInt(data.field.selectionStatus);
						}
						currentPage = 1;
						loadResultsList();
						return false;
					});

					// 重置搜索
					$('#resetBtn').click(function() {
						$('#searchForm')[0].reset();
						searchParams = {};
						currentPage = 1;
						loadResultsList();
					});
				}

				// 查看课题学生
				window.viewTopicStudents = function(topicId) {
					const topics = getAllTopics();
					const topic = topics.find(t => t.id == topicId);
					if (!topic) return;
					
					const students = getStudentsByTopicId(topicId);
					
					// 填充弹窗数据
					$('#modalTopicName').text(topic.topicName);
					$('#modalTeacher').text(topic.teacherName);
					
					// 生成学生列表
					let studentsHtml = '';
					if (students.length > 0) {
						studentsHtml = '<table class="layui-table"><thead><tr><th>序号</th><th>姓名</th><th>学号</th><th>专业</th><th>操作</th></tr></thead><tbody>';
						students.forEach((student, index) => {
							studentsHtml += `
								<tr>
									<td>${index + 1}</td>
									<td>${student.studentName}</td>
									<td>${student.studentId}</td>
									<td>${student.majorName}</td>
									<td>
										<button class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeStudentFromTopic(${student.id}, ${topicId})">
											移除
										</button>
									</td>
								</tr>
							`;
						});
						studentsHtml += '</tbody></table>';
					} else {
						studentsHtml = '<div style="text-align:center; padding:20px;">暂无学生选择该课题</div>';
					}
					
					$('#modalStudentsList').html(studentsHtml);
					
					// 打开弹窗
					modalIndex = layer.open({
						title: `课题学生列表 - ${topic.topicName}`,
						type: 1,
						area: '800px',
						content: $('#studentsModal').html()
					});
				}

				// 分配学生到课题
				window.assignStudents = function(topicId) {
					const topics = getAllTopics();
					const topic = topics.find(t => t.id == topicId);
					if (!topic) return;
					
					// 获取已选学生数量
					const selectedStudents = getStudentsByTopicId(topicId);
					const selectedCount = selectedStudents.length;
					const availableCount = topic.studentNum - selectedCount;
					
					// 填充弹窗基本信息
					$('#assignTopicName').text(topic.topicName);
					$('#assignStudentNum').text(topic.studentNum);
					$('#assignedCount').text(selectedCount);
					$('#availableCount').text(availableCount);
					$('input[name="topicId"]').val(topicId);
					
					// 获取未选题学生
					const allStudents = getAllStudents();
					const unselectedStudents = allStudents.filter(student => 
						!student.topicId || student.topicId === null || student.topicId === ''
					);
					
					// 填充未选题学生下拉框
					let studentsHtml = '';
					if (unselectedStudents.length > 0) {
						unselectedStudents.forEach(student => {
							studentsHtml += `<option value="${student.id}">${student.studentName}(${student.studentId}) - ${student.majorName}</option>`;
						});
					} else {
						studentsHtml = '<option value="">暂无未选题学生</option>';
					}
					$('#unselectedStudentsSelect').html(studentsHtml);
					form.render('select');
					
					// 打开弹窗
					modalIndex = layer.open({
						title: `分配学生 - ${topic.topicName}`,
						type: 1,
						area: '600px',
						content: $('#assignModal').html()
					});
					
					// 绑定保存事件
					form.on('submit(saveAssignment)', function(data) {
						saveStudentAssignment(data.field);
						return false;
					});
				}

				// 保存学生分配
				function saveStudentAssignment(formData) {
					const topicId = parseInt(formData.topicId);
					const studentIds = formData.studentId ? 
						(Array.isArray(formData.studentId) ? formData.studentId : [formData.studentId]) : 
						[];
					
					if (studentIds.length === 0) {
						layer.msg('请选择学生', {icon: 2});
						return;
					}
					
					// 获取课题信息
					const topics = getAllTopics();
					const topic = topics.find(t => t.id == topicId);
					if (!topic) return;
					
					// 检查是否超过最大人数
					const currentStudents = getStudentsByTopicId(topicId);
					if (currentStudents.length + studentIds.length > topic.studentNum) {
						layer.msg(`分配学生数量超过课题最大限制(${topic.studentNum}人)`, {icon: 2});
						return;
					}
					
					// 更新学生信息
					let allStudents = getAllStudents();
					allStudents = allStudents.map(student => {
						if (studentIds.includes(student.id.toString())) {
							return {
								...student,
								topicId: topicId,
								topicName: topic.topicName,
								teacherId: topic.teacherId,
								teacherName: topic.teacherName
							};
						}
						return student;
					});
					
					saveStudents(allStudents);
					layer.close(modalIndex);
					loadResultsList();
					updateStatistics();
					layer.msg('学生分配成功', {icon: 1});
				}

				// 从课题中移除学生
				window.removeStudentFromTopic = function(studentId, topicId) {
					layer.confirm('确定要将该学生从课题中移除吗？', {
						icon: 3,
						title: '提示'
					}, function(index) {
						// 更新学生信息
						let allStudents = getAllStudents();
						allStudents = allStudents.map(student => {
							if (student.id == studentId) {
								return {
									...student,
									topicId: null,
									topicName: '未选题',
									teacherId: '',
									teacherName: ''
								};
							}
							return student;
						});
						
						saveStudents(allStudents);
						layer.close(index);
						layer.close(modalIndex); // 关闭学生列表弹窗
						loadResultsList();
						updateStatistics();
						layer.msg('学生已移除', {icon: 1});
					});
				}

				// 导出结果
				window.exportResults = function() {
					// 在实际应用中，这里会实现真正的导出功能
					// 如导出Excel文件等
					layer.msg('导出功能已触发，在实际应用中会生成Excel文件', {icon: 1});
					console.log('导出选题结果数据:', {
						topics: getAllTopics(),
						students: getAllStudents(),
						exportTime: new Date().toLocaleString()
					});
				}

				// 关闭弹窗
				window.closeModal = function() {
					layer.close(modalIndex);
				}
			});
		</script>
	</body>
</html>
