<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>课题列表 - 毕业设计课题选择管理系统</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
		<link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
		<link rel="stylesheet" href="../css/public.css" media="all">
		<style>
			.layui-card {
				margin-bottom: 15px;
			}

			.layui-form-item {
				margin-bottom: 15px;
			}

			.operation-btn {
				margin-right: 5px;
			}

			.add-btn-container {
				text-align: right;
				margin-bottom: 10px;
			}

			.reset-data-btn {
				margin-left: 10px;
				background-color: #FF5722;
			}
		</style>
	</head>
	<body>
		<div class="layuimini-container">
			<div class="layuimini-main">
				<!-- 页面标题区域 -->
				<div class="layui-card">
					<div class="layui-card-header">
						<i class="fa fa-list icon"></i>课题列表
						<button class="layui-btn layui-btn-primary layui-btn-sm"
						<button class="layui-btn layui-btn-sm reset-data-btn" onclick="forceInitData()">
							<i class="fa fa-refresh"></i> 重新加载20条数据
						</button>
					</div>
				</div>

				<!-- 搜索和添加区域 -->
				<div class="layui-card">
					<div class="layui-card-body">
						<div class="add-btn-container">
							<button class="layui-btn" onclick="openAddModal()">
								<i class="fa fa-plus"></i> 新增课题
							</button>
						</div>

						<form class="layui-form" lay-filter="searchForm" id="searchForm">
							<div class="layui-form-item">
								<div class="layui-col-md3">
									<input type="text" name="topicName" placeholder="模糊搜课题名（如：图像）" autocomplete="off"
										class="layui-input">
								</div>
								<div class="layui-col-md3">
									<select name="teacher">
										<option value="">所有教师</option>
										<option value="1">张教授</option>
										<option value="2">李副教授</option>
										<option value="3">王老师</option>
										<option value="4">赵讲师</option>
										<option value="5">刘教授</option>
									</select>
								</div>
								<div class="layui-col-md3">
									<select name="status">
										<option value="">所有状态</option>
										<option value="1">已发布</option>
										<option value="2">待审核</option>
										<option value="3">已选中</option>
										<option value="4">已结项</option>
									</select>
								</div>
								<div class="layui-col-md3">
									<button class="layui-btn" lay-submit lay-filter="searchBtn"><i
											class="fa fa-search"></i> 搜索</button>
									<button type="reset" class="layui-btn layui-btn-primary" id="resetBtn"><i
											class="fa fa-refresh"></i> 重置搜索</button>
								</div>
							</div>
						</form>
					</div>
				</div>

				<!-- 课题列表 -->
				<div class="layui-card">
					<div class="layui-card-body">
						<table class="layui-table" lay-size="sm">
							<thead>
								<tr>
									<th>序号</th>
									<th>课题名称</th>
									<th>指导教师</th>
									<th>课题类型</th>
									<th>学生人数</th>
									<th>状态</th>
									<th>发布时间</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="topicTableBody">
								<!-- 数据将动态生成 -->
							</tbody>
						</table>

						<div id="pagination" style="text-align: right;"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- 添加/编辑弹窗 -->
		<div id="topicModal" style="display: none;">
			<form class="layui-form" lay-filter="topicForm" id="topicForm">
				<input type="hidden" name="id">
				<div class="layui-form-item">
					<label class="layui-form-label">课题名称</label>
					<div class="layui-input-block">
						<input type="text" name="topicName" required
							lay-verify="required|topicNameLength|topicNameUnique|validChar|chineseOnly"
							placeholder="请输入课题名称（2-50汉字）" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">指导教师</label>
					<div class="layui-input-block">
						<select name="teacherId" required lay-verify="required">
							<option value="">请选择教师</option>
							<option value="1">张教授</option>
							<option value="2">李副教授</option>
							<option value="3">王老师</option>
							<option value="4">赵讲师</option>
							<option value="5">刘教授</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题类型</label>
					<div class="layui-input-block">
						<select name="type" required lay-verify="required" onchange="validateStudentNumWithType()">
							<option value="1">研究型（最多2人）</option>
							<option value="2">应用型（最多4人）</option>
							<option value="3">设计型（最多3人）</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">学生人数</label>
					<div class="layui-input-block">
						<input type="number" name="studentNum" required lay-verify="required|number|studentNumWithType"
							min="1" max="10" placeholder="请输入人数" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题状态</label>
					<div class="layui-input-block">
						<select name="status" required lay-verify="required">
							<option value="1">已发布</option>
							<option value="2">待审核</option>
							<option value="3">已选中</option>
							<option value="4">已结项</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题描述</label>
					<div class="layui-input-block">
						<textarea name="description" lay-verify="descriptionLength|validChar|chineseOnly"
							placeholder="请输入课题描述（最多500汉字）" class="layui-textarea"></textarea>
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn" lay-submit lay-filter="saveTopic">保存</button>
						<button type="button" class="layui-btn layui-btn-primary" onclick="closeModal()">取消</button>
					</div>
				</div>
			</form>
		</div>

		<!-- 详情弹窗 -->
		<div id="detailModal" style="display: none;">
			<div class="layui-form">
				<div class="layui-form-item">
					<label class="layui-form-label">课题名称</label>
					<div class="layui-input-block" id="detailTopicName"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">指导教师</label>
					<div class="layui-input-block" id="detailTeacher"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题类型</label>
					<div class="layui-input-block" id="detailType"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">学生人数</label>
					<div class="layui-input-block" id="detailStudentNum"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题状态</label>
					<div class="layui-input-block" id="detailStatus"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">发布时间</label>
					<div class="layui-input-block" id="detailCreateTime"></div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">课题描述</label>
					<div class="layui-input-block" id="detailDescription"
						style="white-space: pre-wrap; line-height: 1.5;"></div>
				</div>
			</div>
		</div>

		<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
		<script>
			layui.use(['form', 'laypage', 'layer'], function() {
				var form = layui.form;
				var laypage = layui.laypage;
				var layer = layui.layer;
				var $ = layui.jquery;

				// 全局变量
				var currentPage = 1;
				var pageSize = 10;
				var totalCount = 0;
				var searchParams = {};
				var modalIndex = null;

				// 初始化页面
				init();

				function init() {
					// 强制初始化20条数据
					forceInitData();
					// 加载列表
					loadTopicList();
					// 绑定事件
					bindEvents();
					// 注册自定义校验规则
					registerCustomValidators();
				}

				// 20条完整模拟数据
				function getFullMockData() {
					return [
						// 张教授（ID:1）的课题
						{
							id: 1,
							topicName: '基于深度学习的图像识别算法研究',
							teacherId: 1,
							teacherName: '张教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-09-01',
							description: '研究CNN、Transformer模型在图像分类中的优化，实现轻量化识别系统'
						},
						{
							id: 2,
							topicName: '智能校园导航系统设计',
							teacherId: 1,
							teacherName: '张教授',
							type: 2,
							typeName: '应用型',
							studentNum: 3,
							status: 3,
							statusName: '已选中',
							createTime: '2025-08-28',
							description: '结合GPS+蓝牙定位，开发Web+小程序导航，支持路径规划'
						},
						{
							id: 3,
							topicName: '零件缺陷机器视觉检测',
							teacherId: 1,
							teacherName: '张教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-09-05',
							description: '用YOLO模型检测机械零件划痕、变形，辅助工业质检'
						},
						{
							id: 4,
							topicName: '校园安防异常行为识别',
							teacherId: 1,
							teacherName: '张教授',
							type: 2,
							typeName: '应用型',
							studentNum: 4,
							status: 2,
							statusName: '待审核',
							createTime: '2025-09-03',
							description: '识别监控中打架、翻越围墙行为，触发声光报警'
						},
						{
							id: 5,
							topicName: '基于视觉的课堂考勤系统',
							teacherId: 1,
							teacherName: '张教授',
							type: 2,
							typeName: '应用型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-08-30',
							description: '通过摄像头自动识别学生考勤状态'
						},

						// 李副教授（ID:2）的课题
						{
							id: 6,
							topicName: 'B2C电商平台设计与实现',
							teacherId: 2,
							teacherName: '李副教授',
							type: 2,
							typeName: '应用型',
							studentNum: 3,
							status: 3,
							statusName: '已选中',
							createTime: '2025-08-25',
							description: '含商品管理、购物车、订单支付模块'
						},
						{
							id: 7,
							topicName: '社交媒体情感分析系统',
							teacherId: 2,
							teacherName: '李副教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-09-02',
							description: '爬取微博评论，用LSTM模型分析情感'
						},
						{
							id: 8,
							topicName: '在线教育直播平台开发',
							teacherId: 2,
							teacherName: '李副教授',
							type: 2,
							typeName: '应用型',
							studentNum: 4,
							status: 1,
							statusName: '已发布',
							createTime: '2025-08-30',
							description: '实现直播推流、弹幕、课程回放功能'
						},
						{
							id: 9,
							topicName: '用户画像与精准推荐研究',
							teacherId: 2,
							teacherName: '李副教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 4,
							statusName: '已结项',
							createTime: '2025-07-15',
							description: '基于用户行为构建画像，做商品推荐'
						},
						{
							id: 10,
							topicName: '电商用户行为分析平台',
							teacherId: 2,
							teacherName: '李副教授',
							type: 2,
							typeName: '应用型',
							studentNum: 3,
							status: 2,
							statusName: '待审核',
							createTime: '2025-09-04',
							description: '分析用户浏览、购买行为，生成销售报表'
						},

						// 王老师（ID:3）的课题
						{
							id: 11,
							topicName: '图书馆书籍智能分类系统',
							teacherId: 3,
							teacherName: '王老师',
							type: 2,
							typeName: '应用型',
							studentNum: 3,
							status: 1,
							statusName: '已发布',
							createTime: '2025-09-04',
							description: '扫描ISBN码自动分类书籍，生成馆藏位置地图'
						},
						{
							id: 12,
							topicName: '基于大数据的学生成绩分析',
							teacherId: 3,
							teacherName: '王老师',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 2,
							statusName: '待审核',
							createTime: '2025-09-01',
							description: '分析成绩分布、学科关联，预测学生挂科风险'
						},
						{
							id: 13,
							topicName: '校园二手交易平台设计',
							teacherId: 3,
							teacherName: '王老师',
							type: 2,
							typeName: '应用型',
							studentNum: 3,
							status: 3,
							statusName: '已选中',
							createTime: '2025-08-27',
							description: '支持书籍、电子产品交易，内置信用评价体系'
						},
						{
							id: 14,
							topicName: '教育数据可视化平台开发',
							teacherId: 3,
							teacherName: '王老师',
							type: 2,
							typeName: '应用型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-08-29',
							description: '将教学数据转化为图表，辅助教学决策'
						},
						{
							id: 15,
							topicName: '校园活动推荐系统',
							teacherId: 3,
							teacherName: '王老师',
							type: 2,
							typeName: '应用型',
							studentNum: 2,
							status: 2,
							statusName: '待审核',
							createTime: '2025-09-05',
							description: '根据学生兴趣推荐社团活动、讲座等'
						},

						// 赵讲师（ID:4）的课题
						{
							id: 16,
							topicName: '移动办公APP设计与实现',
							teacherId: 4,
							teacherName: '赵讲师',
							type: 3,
							typeName: '设计型',
							studentNum: 3,
							status: 1,
							statusName: '已发布',
							createTime: '2025-08-26',
							description: '包含日程管理、任务分配、文件共享功能'
						},
						{
							id: 17,
							topicName: '校园失物招领平台开发',
							teacherId: 4,
							teacherName: '赵讲师',
							type: 2,
							typeName: '应用型',
							studentNum: 2,
							status: 3,
							statusName: '已选中',
							createTime: '2025-09-02',
							description: '支持物品发布、认领、管理员审核流程'
						},

						// 刘教授（ID:5）的课题
						{
							id: 18,
							topicName: '新能源汽车电池管理系统研究',
							teacherId: 5,
							teacherName: '刘教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 1,
							statusName: '已发布',
							createTime: '2025-08-24',
							description: '研究电池充放电效率优化算法'
						},
						{
							id: 19,
							topicName: '智能家居控制系统设计',
							teacherId: 5,
							teacherName: '刘教授',
							type: 3,
							typeName: '设计型',
							studentNum: 3,
							status: 2,
							statusName: '待审核',
							createTime: '2025-09-01',
							description: '实现灯光、窗帘、空调的联动控制'
						},
						{
							id: 20,
							topicName: '基于区块链的学历认证系统',
							teacherId: 5,
							teacherName: '刘教授',
							type: 1,
							typeName: '研究型',
							studentNum: 2,
							status: 4,
							statusName: '已结项',
							createTime: '2025-07-20',
							description: '利用区块链不可篡改特性实现学历防伪'
						}
					];
				}

				// 强制初始化数据
				function forceInitData() {
					const fullData = getFullMockData();
					localStorage.setItem('topics', JSON.stringify(fullData));
				}

				// 获取所有课题数据
				function getAllTopics() {
					return JSON.parse(localStorage.getItem('topics') || '[]');
				}

				// 保存课题数据
				function saveTopics(topics) {
					localStorage.setItem('topics', JSON.stringify(topics));
				}

				// 加载课题列表
				function loadTopicList() {
					let allTopics = getAllTopics();

					// 搜索过滤逻辑
					let filteredTopics = allTopics.filter(topic => {
						// 课题名称模糊搜索（忽略大小写）
						if (searchParams.topicName) {
							const searchStr = searchParams.topicName.toLowerCase();
							if (!topic.topicName.toLowerCase().includes(searchStr)) {
								return false;
							}
						}
						// 教师筛选
						if (searchParams.teacher && topic.teacherId != searchParams.teacher) {
							return false;
						}
						// 状态筛选
						if (searchParams.status && topic.status != searchParams.status) {
							return false;
						}
						return true;
					});

					// 分页处理
					totalCount = filteredTopics.length;
					let startIndex = (currentPage - 1) * pageSize;
					let currentTopics = filteredTopics.slice(startIndex, startIndex + pageSize);

					// 渲染表格
					renderTable(currentTopics);
					// 渲染分页
					renderPagination();
				}

				// 渲染表格
				function renderTable(topics) {
					const tableBody = $('#topicTableBody');
					tableBody.empty();

					if (topics.length === 0) {
						tableBody.html('<tr><td colspan="8" style="text-align: center;">暂无数据</td></tr>');
						return;
					}

					topics.forEach((topic, index) => {
						const statusStyles = {
							1: 'layui-bg-green',
							2: 'layui-bg-orange',
							3: 'layui-bg-blue',
							4: 'layui-bg-gray'
						};

						const tr = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${topic.topicName}</td>
                        <td>${topic.teacherName}</td>
                        <td>${topic.typeName}</td>
                        <td>${topic.studentNum}</td>
                        <td><span class="layui-badge ${statusStyles[topic.status]}">${topic.statusName}</span></td>
                        <td>${topic.createTime}</td>
                        <td>
                            <button class="layui-btn layui-btn-xs operation-btn" onclick="viewTopic(${topic.id})">查看</button>
                            <button class="layui-btn layui-btn-normal layui-btn-xs operation-btn" onclick="editTopic(${topic.id})">编辑</button>
                            <button class="layui-btn layui-btn-danger layui-btn-xs operation-btn" onclick="deleteTopic(${topic.id})">删除</button>
                        </td>
                    </tr>
                `;
						tableBody.append(tr);
					});
				}

				// 渲染分页
				function renderPagination() {
					laypage.render({
						elem: 'pagination',
						count: totalCount,
						limit: pageSize,
						limits: [5, 10, 15, 20],
						curr: currentPage,
						layout: ['prev', 'page', 'next', 'count', 'limit', 'skip'],
						jump: function(obj, first) {
							if (!first) {
								currentPage = obj.curr;
								pageSize = obj.limit;
								loadTopicList();
							}
						}
					});
				}

				// 绑定事件
				function bindEvents() {
					// 搜索事件
					form.on('submit(searchBtn)', function(data) {
						searchParams = {};
						if (data.field.topicName && data.field.topicName.trim() !== '') {
							searchParams.topicName = data.field.topicName.trim();
						}
						if (data.field.teacher) {
							searchParams.teacher = data.field.teacher;
						}
						if (data.field.status) {
							searchParams.status = data.field.status;
						}
						currentPage = 1;
						loadTopicList();
						return false;
					});

					// 重置搜索
					$('#resetBtn').click(function() {
						$('#searchForm')[0].reset();
						searchParams = {};
						currentPage = 1;
						loadTopicList();
					});
				}

				// 注册自定义校验规则（增强的校验功能）
				function registerCustomValidators() {
					// 1. 课题名称重复校验（新增时不允许重复，编辑时允许与自身重复）
					form.verify({
						topicNameUnique: function(value, item) {
							const topics = getAllTopics();
							const currentId = $(item).closest('#topicForm').find('input[name="id"]').val();
							const isDuplicate = topics.some(topic => {
								return topic.topicName.trim() === value.trim() && topic.id !=
									currentId;
							});
							if (isDuplicate) {
								return '该课题名称已存在，请修改！';
							}
						},
						// 2. 课题名称长度限制（2-50字）
						topicNameLength: function(value) {
							const trimValue = value.trim();
							if (trimValue.length < 2) {
								return '课题名称至少2个字符！';
							}
							if (trimValue.length > 50) {
								return '课题名称最多50个字符！';
							}
						},
						// 3. 课题描述长度限制（0-500字）
						descriptionLength: function(value) {
							if (value.length > 500) {
								return '课题描述最多500个字符！';
							}
						},
						// 4. 学生人数与课题类型关联校验
						studentNumWithType: function(value, item) {
							const studentNum = parseInt(value);
							const topicType = $(item).closest('#topicForm').find('select[name="type"]')
						.val();
							let maxNum = 10;

							if (topicType == 1) maxNum = 2; // 研究型：最多2人
							else if (topicType == 2) maxNum = 4; // 应用型：最多4人
							else if (topicType == 3) maxNum = 3; // 设计型：最多3人

							if (studentNum > maxNum) {
								const typeName = topicType == 1 ? '研究型' : (topicType == 2 ? '应用型' : '设计型');
								return `${typeName}课题最多允许${maxNum}人，当前输入${studentNum}人！`;
							}
						},
						// 5. 过滤特殊字符
						validChar: function(value, item) {
							const invalidReg = /[`~!@#$%^&*()_+<>?:"{},.\/;'[\]\\|=~￥…（）—【】、；：”“’。，、？]/im;
							if (invalidReg.test(value.trim())) {
								const fieldName = $(item).prev('label').text().replace('：', '');
								return `${fieldName}不允许包含特殊字符（如~!@#$%等）！`;
							}
						},
						// 6. 只能输入汉字校验
						chineseOnly: function(value, item) {
							// 允许为空（空值由required规则处理）
							if (!value.trim()) return;

							// 匹配所有汉字（包括简体、繁体和扩展汉字）
							const chineseReg = /^[\u4e00-\u9fa5]+$/;
							if (!chineseReg.test(value.trim())) {
								const fieldName = $(item).prev('label').text().replace('：', '');
								return `${fieldName}只能输入汉字！`;
							}
						}
					});
				}

				// 当课题类型改变时重新校验学生人数
				window.validateStudentNumWithType = function() {
					const studentNumInput = $('input[name="studentNum"]');
					if (studentNumInput.val()) {
						form.validate('studentNumWithType', studentNumInput.val(), studentNumInput[0]);
					}
				}

				// 打开添加弹窗
				window.openAddModal = function() {
					form.val('topicForm', {
						id: '',
						topicName: '',
						teacherId: '',
						type: '1',
						studentNum: '',
						status: '1',
						description: ''
					});

					modalIndex = layer.open({
						title: '新增课题',
						type: 1,
						area: '600px',
						content: $('#topicModal').html()
					});

					form.render();
					form.on('submit(saveTopic)', function(data) {
						saveTopicData(data.field);
						return false;
					});
				}

				// 编辑课题
				window.editTopic = function(id) {
					const topics = getAllTopics();
					const topic = topics.find(t => t.id == id);
					if (!topic) return;

					form.val('topicForm', {
						id: topic.id,
						topicName: topic.topicName,
						teacherId: topic.teacherId,
						type: topic.type,
						studentNum: topic.studentNum,
						status: topic.status,
						description: topic.description
					});

					modalIndex = layer.open({
						title: '编辑课题',
						type: 1,
						area: '600px',
						content: $('#topicModal').html()
					});

					form.render();
					form.on('submit(saveTopic)', function(data) {
						saveTopicData(data.field);
						return false;
					});
				}

				// 查看课题
				window.viewTopic = function(id) {
					const topics = getAllTopics();
					const topic = topics.find(t => t.id == id);
					if (!topic) return;

					$('#detailTopicName').text(topic.topicName);
					$('#detailTeacher').text(topic.teacherName);
					$('#detailType').text(topic.typeName);
					$('#detailStudentNum').text(topic.studentNum);

					const statusStyles = {
						1: 'layui-bg-green',
						2: 'layui-bg-orange',
						3: 'layui-bg-blue',
						4: 'layui-bg-gray'
					};
					$('#detailStatus').html(
						`<span class="layui-badge ${statusStyles[topic.status]}">${topic.statusName}</span>`);

					$('#detailCreateTime').text(topic.createTime);
					$('#detailDescription').text(topic.description);

					modalIndex = layer.open({
						title: '课题详情',
						type: 1,
						area: '600px',
						content: $('#detailModal').html()
					});
				}

				// 保存课题数据
				function saveTopicData(formData) {
					const topics = getAllTopics();
					const teacherMap = {
						'1': '张教授',
						'2': '李副教授',
						'3': '王老师',
						'4': '赵讲师',
						'5': '刘教授'
					};
					const typeMap = {
						'1': {
							id: 1,
							name: '研究型'
						},
						'2': {
							id: 2,
							name: '应用型'
						},
						'3': {
							id: 3,
							name: '设计型'
						}
					};
					const statusMap = {
						'1': {
							id: 1,
							name: '已发布'
						},
						'2': {
							id: 2,
							name: '待审核'
						},
						'3': {
							id: 3,
							name: '已选中'
						},
						'4': {
							id: 4,
							name: '已结项'
						}
					};

					// 格式化日期
					const formatDate = () => {
						const date = new Date();
						return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
					};

					if (formData.id) {
						// 编辑
						const index = topics.findIndex(t => t.id == formData.id);
						if (index !== -1) {
							topics[index] = {
								...topics[index],
								topicName: formData.topicName,
								teacherId: parseInt(formData.teacherId),
								teacherName: teacherMap[formData.teacherId],
								type: typeMap[formData.type].id,
								typeName: typeMap[formData.type].name,
								studentNum: parseInt(formData.studentNum),
								status: statusMap[formData.status].id,
								statusName: statusMap[formData.status].name,
								description: formData.description
							};
						}
					} else {
						// 新增
						const newId = topics.length > 0 ? Math.max(...topics.map(t => t.id)) + 1 : 1;
						topics.push({
							id: newId,
							topicName: formData.topicName,
							teacherId: parseInt(formData.teacherId),
							teacherName: teacherMap[formData.teacherId],
							type: typeMap[formData.type].id,
							typeName: typeMap[formData.type].name,
							studentNum: parseInt(formData.studentNum),
							status: statusMap[formData.status].id,
							statusName: statusMap[formData.status].name,
							createTime: formatDate(),
							description: formData.description
						});
					}

					saveTopics(topics);
					layer.close(modalIndex);
					loadTopicList();
					layer.msg(formData.id ? '修改成功' : '新增成功', {
						icon: 1
					});
				}

				// 删除课题
				window.deleteTopic = function(id) {
					layer.confirm('确定要删除这个课题吗？', {
						icon: 3,
						title: '提示'
					}, function(index) {
						let topics = getAllTopics();
						topics = topics.filter(topic => topic.id != id);
						saveTopics(topics);

						layer.close(index);
						loadTopicList();
						layer.msg('删除成功', {
							icon: 1
						});
					});
				}

				// 关闭弹窗
				window.closeModal = function() {
					layer.close(modalIndex);
					z
				}
			});
		</script>
	</body>
</html>